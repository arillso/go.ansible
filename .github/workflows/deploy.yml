---
name: Deployment

on:
    push:
        tags:
            - "v*.*.*"
            - "[0-9]*.[0-9]*.[0-9]*"

permissions:
    contents: write
    id-token: write
    attestations: write

concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: false

jobs:
    prepare:
        name: Prepare
        runs-on: ubuntu-latest
        timeout-minutes: 5
        outputs:
            version: ${{ steps.version.outputs.version }}
            is-prerelease: ${{ steps.version.outputs.is-prerelease }}
        steps:
            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

            - name: Determine version
              id: version
              run: |
                  VERSION="${GITHUB_REF#refs/tags/}"
                  VERSION="${VERSION#v}"
                  echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

                  if [[ "${VERSION}" =~ -[a-zA-Z] ]]; then
                      echo "is-prerelease=true" >> "$GITHUB_OUTPUT"
                  else
                      echo "is-prerelease=false" >> "$GITHUB_OUTPUT"
                  fi

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: prepare
        timeout-minutes: 15
        steps:
            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

            - name: Setup Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Build module
              run: go build -v ./...

            - name: Run tests
              run: go test -v ./...

    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: [prepare, build]
        timeout-minutes: 10
        steps:
            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

            - name: Extract changelog
              id: changelog
              run: |
                  VERSION="${{ needs.prepare.outputs.version }}"

                  if grep -q "## \[${VERSION}\]" CHANGELOG.md; then
                      awk '/^## \['"${VERSION}"'\]/{flag=1; next} /^## \[.*\]/ && flag {exit} flag' CHANGELOG.md > release_notes.md
                      echo "found=true" >> "$GITHUB_OUTPUT"
                  else
                      echo "Release ${VERSION}" > release_notes.md
                      echo "found=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Create GitHub Release
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
              with:
                  name: v${{ needs.prepare.outputs.version }}
                  body_path: release_notes.md
                  prerelease: ${{ needs.prepare.outputs.is-prerelease }}
                  generate_release_notes: ${{ steps.changelog.outputs.found == 'false' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
